(function($,infrae){var AddMode=function($component){var view=this,$placeholder=$('<div class="contentlayout-component contentlayout-valid-placeholder"></div>'),$helper=null,block=infrae.smi.layout.components.Block(),slot=null,validator=null,deferred=$.Deferred(),finishing=!1,$body=$("body"),save=function(event){finish(event,!1),void 0!==event&&(event.stopPropagation(),event.preventDefault())},cancel=function(event){finish(event,!0),void 0!==event&&(event.stopPropagation(),event.preventDefault())},finish=function(event,failed){return finishing?$.Deferred():(finishing=!0,view.shortcuts.remove("editor","adding"),$body.css("cursor","inherit"),(null!==validator&&failed!==!0?validator.done(function(){$placeholder.attr("class","contentlayout-component contentlayout-placeholder")}).always(function(){null!==$helper&&$helper.remove()}).then(view.transport.add,function(){return $.Deferred().reject()}):$.Deferred().reject().always(function(){null!==$helper&&$helper.remove()})).then(function(data){return data.block_id?(block.set(data),data):$.Deferred().reject()},function(){return $.Deferred().reject()}).always(function(){block.placeholder.clear()}).fail(function(){null!==slot&&slot.remove(block),block.destroy()}).always(function(){null!==slot&&slot.$slot.removeClass("contentlayout-over-slot"),view.slots.update(),view.slots.events.restore(event),view.$body.css("cursor","inherit"),$component.removeClass("selected"),deferred.resolve()}))},reorder=function(info){var index=0,position={$container:info.slot.$slot,$item:[]},first=null===slot;if(void 0!==info.current.$block&&(position.$item=info.current.$block,index=info.slot.index(info.current),!info.slot.horizontal&&info.mouse.direction.bottom||info.slot.horizontal&&info.mouse.direction.right?(index+=1,position.direction="after"):position.direction="before",info.slot===slot)){var current=slot.index(block);index>current&&(index-=1)}info.slot.get(index)!==block&&(first||(slot.remove(block),slot.$slot.removeClass("contentlayout-over-slot")),slot=info.slot,slot.add(block,index),first&&($placeholder.html($component.children().clone()),block.placehold($placeholder,"1em","8em",!1)),block.deplace(position,slot.horizontal),view.slots.update(),$placeholder.attr("class","contentlayout-component contentlayout-placeholder"),slot.$slot.addClass("contentlayout-over-slot"),validator=view.transport.addable({slot:slot,block:block,name:$component.data("block-name"),index:index}).then(function(data){var result=$.Deferred();return data.success?($placeholder.attr("class","contentlayout-component contentlayout-valid-placeholder"),result.resolve(data)):($placeholder.attr("class","contentlayout-component contentlayout-invalid-placeholder"),result.reject(data)),result},function(){finish(!0)}))},bootstrap=function(){$component.addClass("selected"),$body.css("cursor","move"),view.$body.css("cursor","move"),view.slots.events.snapshot(),view.slots.events.onenter(function(){reorder(this)}),view.slots.events.onmove(function(){null===$helper?($helper=$component.clone(),$helper.css("position","absolute"),$helper.css("opacity","0.6"),$helper.zIndex("100000"),$helper.offset(this.mouse.offset),view.$body.append($helper)):$helper.offset(this.mouse.offset),null!==this.current&&this.mouse.changed!==!1&&reorder(this)}),view.slots.events.ondrop(save),view.slots.events.oncancel(cancel),view.shortcuts.bind("editor","adding",["ctrl+s"],save),view.shortcuts.bind("editor","adding",["esc"],cancel)};return bootstrap(),{type:"add",cancel:cancel,save:save,promise:deferred.promise}},RemoveMode=function(original){var view=this,deferred=infrae.ui.ConfirmationDialog({title:"Remove component",message:"Please confirm the permanent deletion of the component ?"}).then(function(){return view.transport.remove(original)},function(){return $.Deferred().reject()});return{type:"remove",cancel:function(){},save:function(){},promise:deferred.promise}},RemoveAllMode=function(original){var view=this,deferred=infrae.ui.ConfirmationDialog({title:"Remove all components",message:"Please confirm the permanent deletion of all selected components ?"});return infrae.utils.each(original,function(original){deferred=deferred.then(function(){return view.transport.remove(original)},function(){return $.Deferred().reject()})}),{type:"remove",cancel:function(){},save:function(){},promise:deferred.promise}},MoveMode=function(original){var view=this,$placeholder=$('<div class="contentlayout-placeholder"></div>'),$helper=null,slot=original.slot,block=original.current,validator=null,finishing=!1,deferred=$.Deferred();original.index=slot.index(block);var save=function(event){finish(event,!1),void 0!==event&&(event.stopPropagation(),event.preventDefault())},cancel=function(event){finish(event,!0),void 0!==event&&(event.stopPropagation(),event.preventDefault())},finish=function(event,failed){return finishing?$.Deferred():(finishing=!0,view.shortcuts.remove("editor","moving"),(null!==validator&&failed!==!0?validator.done(function(){$placeholder.attr("class","contentlayout-placeholder")}).then(view.transport.move,function(){return $.Deferred().reject()}):$.Deferred().reject({success:!0,slot:slot,current:block})).done(function(){block.placeholder.clear()}).fail(function(){(original.slot!==slot||original.index!==slot.index(block))&&(slot.remove(block),original.slot.add(block,original.index)),block.placeholder.revert()}).always(function(){$helper.remove(),slot.$slot.removeClass("contentlayout-over-slot"),view.slots.update(),view.slots.events.restore(event),view.$body.css("cursor","inherit"),deferred.resolve()}))},validate=function(index){$placeholder.attr("class","contentlayout-placeholder"),validator=view.transport.movable({slot:slot,current:block,index:index}).then(function(data){var result=$.Deferred();return data.success?($placeholder.attr("class","contentlayout-valid-placeholder"),result.resolve(data)):($placeholder.attr("class","contentlayout-invalid-placeholder"),result.reject(data)),result},function(){finish(!0)})},reorder=function(info){var index=0,position={$container:info.slot.$slot,$item:[]};if(void 0!==info.current.$block&&(position.$item=info.current.$block,index=info.slot.index(info.current),!info.slot.horizontal&&info.mouse.direction.bottom||info.slot.horizontal&&info.mouse.direction.right?(index+=1,position.direction="after"):position.direction="before",info.slot===slot)){var current=slot.index(block);index>current&&(index-=1)}info.slot.get(index)!==block&&(slot.remove(block),slot.$slot.removeClass("contentlayout-over-slot"),info.slot.add(block,index),slot=info.slot,slot.$slot.addClass("contentlayout-over-slot"),block.deplace(position,slot.horizontal),view.slots.update(),validate(index))},bootstrap=function(){$helper=block.$block.clone(),$helper.css("position","absolute"),$helper.css("opacity","0.6"),$helper.zIndex("100000"),$helper.offset(original.mouse),view.$body.append($helper),view.$body.css("cursor","move"),block.placehold($placeholder),slot.$slot.addClass("contentlayout-over-slot"),validate(0),view.slots.events.snapshot(),view.slots.events.onenter(function(){reorder(this)}),view.slots.events.onmove(function(){$helper.offset(this.mouse.offset),null!==this.current&&this.mouse.changed!==!1&&reorder(this)}),view.slots.events.ondrop(save),view.slots.events.oncancel(cancel),view.shortcuts.bind("editor","moving",["ctrl+s"],save),view.shortcuts.bind("editor","moving",["esc"],cancel)};return bootstrap(),{type:"move",cancel:cancel,save:save,promise:deferred.promise}};$.extend(infrae.smi.layout,{AddMode:AddMode,RemoveMode:RemoveMode,RemoveAllMode:RemoveAllMode,MoveMode:MoveMode})})(jQuery,infrae,jsontemplate);