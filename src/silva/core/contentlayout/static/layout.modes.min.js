(function(e,t,n){var r=function(n){var r=this,i=e('<div class="contentlayout-component contentlayout-valid-placeholder"></div>'),s=null,o=t.smi.layout.components.Block(),u=null,a=null,f=e.Deferred(),l=!1,c=e("body"),h=function(e){d(e,!1),e!==undefined&&(e.stopPropagation(),e.preventDefault())},p=function(e){d(e,!0),e!==undefined&&(e.stopPropagation(),e.preventDefault())},d=function(t,h){return l?e.Deferred():(l=!0,r.shortcuts.remove("editor","adding"),c.css("cursor","inherit"),(a!==null&&h!==!0?a.done(function(){i.attr("class","contentlayout-component contentlayout-placeholder")}).always(function(){s!==null&&s.remove()}).pipe(r.transport.add,function(){return e.Deferred().reject()}):e.Deferred().reject().always(function(){s!==null&&s.remove()})).pipe(function(t){return t.block_id?(o.set(t),t):e.Deferred().reject()},function(){return e.Deferred().reject()}).always(function(){o.placeholder.clear()}).fail(function(){u!==null&&u.remove(o),o.destroy()}).always(function(){u!==null&&u.$slot.removeClass("contentlayout-over-slot"),r.slots.update(),r.slots.events.restore(t),r.$body.css("cursor","inherit"),n.removeClass("selected"),f.resolve()}))},v=function(t){var s=0,f={$container:t.slot.$slot,$item:[]},l=u===null;if(t.current.$block!==undefined){f.$item=t.current.$block,s=t.slot.index(t.current),!t.slot.horizontal&&t.mouse.direction.bottom||t.slot.horizontal&&t.mouse.direction.right?(s+=1,f.direction="after"):f.direction="before";if(t.slot===u){var c=u.index(o);c<s&&(s-=1)}}t.slot.get(s)!==o&&(l||(u.remove(o),u.$slot.removeClass("contentlayout-over-slot")),u=t.slot,u.add(o,s),l&&(i.html(n.children().clone()),o.placehold(i,"1em","8em",!1)),o.deplace(f,u.horizontal),r.slots.update(),i.attr("class","contentlayout-component contentlayout-placeholder"),u.$slot.addClass("contentlayout-over-slot"),a=r.transport.addable({slot:u,block:o,name:n.data("block-name"),index:s}).pipe(function(t){var n=e.Deferred();return t.success?(i.attr("class","contentlayout-component contentlayout-valid-placeholder"),n.resolve(t)):(i.attr("class","contentlayout-component contentlayout-invalid-placeholder"),n.reject(t)),n},function(e){d(!0)}))},m=function(){n.addClass("selected"),c.css("cursor","move"),r.$body.css("cursor","move"),r.slots.events.snapshot(),r.slots.events.onenter(function(e){v(this)}),r.slots.events.onmove(function(e){s===null?(s=n.clone(),s.css("position","absolute"),s.css("opacity","0.6"),s.zIndex("100000"),s.offset(this.mouse.offset),r.$body.append(s)):s.offset(this.mouse.offset),this.current!==null&&this.mouse.changed!==!1&&v(this)}),r.slots.events.ondrop(h),r.slots.events.oncancel(p),r.shortcuts.bind("editor","adding",["ctrl+s"],h),r.shortcuts.bind("editor","adding",["esc"],p)};return m(),{type:"add",cancel:p,save:h,promise:f.promise}},i=function(n){var r=this,i=t.ui.ConfirmationDialog({title:"Remove component",message:"Please confirm the permanent deletion of the component ?"}).pipe(function(){return r.transport.remove(n)},function(){return e.Deferred().reject()});return{type:"remove",cancel:function(){},save:function(){},promise:i.promise}},s=function(t){var n=this,r=e('<div class="contentlayout-placeholder"></div>'),i=null,s=t.slot,o=t.current,u=null,a=!1,f=e.Deferred();t.index=s.index(o);var l=function(e){h(e,!1),e!==undefined&&(e.stopPropagation(),e.preventDefault())},c=function(e){h(e,!0),e!==undefined&&(e.stopPropagation(),e.preventDefault())},h=function(l,c){return a?e.Deferred():(a=!0,n.shortcuts.remove("editor","moving"),(u!==null&&c!==!0?u.done(function(){r.attr("class","contentlayout-placeholder")}).pipe(n.transport.move,function(){return e.Deferred().reject()}):e.Deferred().reject({success:!0,slot:s,current:o})).done(function(){o.placeholder.clear()}).fail(function(){if(t.slot!==s||t.index!==s.index(o))s.remove(o),t.slot.add(o,t.index);o.placeholder.revert()}).always(function(){i.remove(),s.$slot.removeClass("contentlayout-over-slot"),n.slots.update(),n.slots.events.restore(l),n.$body.css("cursor","inherit"),f.resolve()}))},p=function(t){r.attr("class","contentlayout-placeholder"),u=n.transport.movable({slot:s,current:o,index:t}).pipe(function(t){var n=e.Deferred();return t.success?(r.attr("class","contentlayout-valid-placeholder"),n.resolve(t)):(r.attr("class","contentlayout-invalid-placeholder"),n.reject(t)),n},function(e){h(!0)})},d=function(e){var t=0,r={$container:e.slot.$slot,$item:[]};if(e.current.$block!==undefined){r.$item=e.current.$block,t=e.slot.index(e.current),!e.slot.horizontal&&e.mouse.direction.bottom||e.slot.horizontal&&e.mouse.direction.right?(t+=1,r.direction="after"):r.direction="before";if(e.slot===s){var i=s.index(o);i<t&&(t-=1)}}e.slot.get(t)!==o&&(s.remove(o),s.$slot.removeClass("contentlayout-over-slot"),e.slot.add(o,t),s=e.slot,s.$slot.addClass("contentlayout-over-slot"),o.deplace(r,s.horizontal),n.slots.update(),p(t))},v=function(){i=o.$block.clone(),i.css("position","absolute"),i.css("opacity","0.6"),i.zIndex("100000"),i.offset(t.mouse),n.$body.append(i),n.$body.css("cursor","move"),o.placehold(r),s.$slot.addClass("contentlayout-over-slot"),p(0),n.slots.events.snapshot(),n.slots.events.onenter(function(e){d(this)}),n.slots.events.onmove(function(e){i.offset(this.mouse.offset),this.current!==null&&this.mouse.changed!==!1&&d(this)}),n.slots.events.ondrop(l),n.slots.events.oncancel(c),n.shortcuts.bind("editor","moving",["ctrl+s"],l),n.shortcuts.bind("editor","moving",["esc"],c)};return v(),{type:"move",cancel:c,save:l,promise:f.promise}};e.extend(t.smi.layout,{AddMode:r,RemoveMode:i,MoveMode:s})})(jQuery,infrae,jsontemplate);