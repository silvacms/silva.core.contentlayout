(function(e,t,n){var r=function(){var e={top:-1,left:-1,threshold:10,changed:!1,offset:{top:-1,left:-1},direction:{right:null,bottom:null,changed:!1},previous:{top:-1,left:-1,direction:{right:null,bottom:null}},update:function(e){return e.pageX==this.left&&e.pageY==this.top?!1:(this.left=e.pageX,this.top=e.pageY,this.offset.left=e.pageX+this.threshold,this.offset.top=e.pageY+this.threshold,this.changed=Math.abs(this.left-this.previous.left)>this.threshold||Math.abs(this.top-this.previous.top)>this.threshold,this.changed&&(this.direction.right=this.left>this.previous.left,this.direction.bottom=this.top>this.previous.top,this.direction.changed=this.direction.right!=this.previous.direction.right||this.direction.bottom!=this.previous.direction.bottom),!0)},finish:function(e){this.changed&&(this.previous.top=this.top,this.previous.left=this.left,this.previous.direction.right=this.direction.right,this.previous.direction.bottom=this.direction.bottom)}};return e},i=function(n,r,i){var s={},o={},u={change:t.deferred.Callbacks()},a={events:{onchange:function(e){u.change.add(e)}},add:function(e){return e.slot.$slot.SMIFormPopup({url:r.actions.add.expand({path:i,slot_id:e.slot.id,block_name:e.name}),payload:[{name:"index",value:e.index}]}).pipe(function(e){return e.extra!==undefined?e.extra:e})},addable:function(t){var s=o[t.slot.id],u=undefined,a={slot:t.slot,block:t.block,name:t.name,index:t.index};return t.slot.editable?(s===undefined&&(s=o[t.slot.id]={}),u=s[t.name],u!==undefined&&!u.isRejected()?u.pipe(function(t){return e.extend(a,{success:t.success,failed:t.failed,fatal:!1})}):s[t.name]=n.ajax.query(r.actions.addable.expand({path:i,slot_id:t.slot.id,block_name:t.name})).pipe(function(t){return e.extend(a,{success:t.success,failed:!t.success,fatal:!1})},function(t){return e.Deferred().reject(e.extend(a,{failed:!0,success:!1,fatal:!0}))})):e.Deferred().resolve(e.extend(a,{failed:!0,success:!1,fatal:!1}))},edit:function(e){return e.current.$block.SMIFormPopup({url:r.actions.edit.expand({path:i,slot_id:e.slot.id,block_id:e.current.id})}).done(function(t){t.extra!==undefined&&(e.current.$block.empty(),e.current.$block.append(t.extra.block_data),u.change.invoke({modified:!0,current:e.current,slot:e.slot}))})},movable:function(t){var o=s[t.current.id],u=undefined,a={slot:t.slot,current:t.current,index:t.index};return t.slot.editable?(o===undefined&&(o=s[t.current.id]={}),u=o[t.slot.id],u!==undefined&&!u.isRejected()?u.pipe(function(t){return e.extend(a,{success:t.success,failed:t.failed,fatal:!1})}):o[t.slot.id]=n.ajax.query(r.actions.movable.expand({path:i,slot_id:t.slot.id,block_id:t.current.id})).pipe(function(t){return e.extend(a,{success:t.success,failed:!t.success,fatal:!1})},function(t){return e.Deferred().reject(e.extend(a,{failed:!0,success:!1,fatal:!0}))})):e.Deferred().resolve(e.extend(a,{failed:!0,success:!1,fatal:!0}))},move:function(t){return n.ajax.query(r.actions.move.expand({path:i,slot_id:t.slot.id,block_id:t.current.id}),[{name:"index",value:t.index}]).pipe(function(n){return e.Deferred().resolve({success:n.success,failed:!n.success,slot:t.slot,current:t.current,index:t.index,fatal:!1})},function(t){return e.Deferred().reject({failed:!0,success:!1,fatal:!0})})},remove:function(e){return n.ajax.query(r.actions.remove.expand({path:i,slot_id:e.slot.id,block_id:e.current.id})).done(function(t){t.success&&(e.slot.remove(e.current),e.current.destroy(),u.change.invoke({removed:!0,current:e.current,slot:e.slot}))})}};return a};e.extend(t.smi.layout,{utils:{Mouse:r,Transport:i}})})(jQuery,infrae,jsontemplate);