(function($,infrae){var Mouse=function(){var api={top:-1,left:-1,threshold:10,changed:!1,offset:{top:-1,left:-1},direction:{right:null,bottom:null,changed:!1},previous:{top:-1,left:-1,direction:{right:null,bottom:null}},update:function(event){return event.pageX==this.left&&event.pageY==this.top?!1:(this.left=event.pageX,this.top=event.pageY,this.offset.left=event.pageX+this.threshold,this.offset.top=event.pageY+this.threshold,this.changed=Math.abs(this.left-this.previous.left)>this.threshold||Math.abs(this.top-this.previous.top)>this.threshold,this.changed&&(this.direction.right=this.left>this.previous.left,this.direction.bottom=this.top>this.previous.top,this.direction.changed=this.direction.right!=this.previous.direction.right||this.direction.bottom!=this.previous.direction.bottom),!0)},finish:function(){this.changed&&(this.previous.top=this.top,this.previous.left=this.left,this.previous.direction.right=this.direction.right,this.previous.direction.bottom=this.direction.bottom)}};return api},Transport=function(smi,urls,path){var validation_move={},validation_add={},events={change:infrae.deferred.Callbacks()},api={events:{onchange:function(callback){events.change.add(callback)}},add:function(state){return state.slot.$slot.SMIFormPopup({url:urls.actions.add.expand({path:path,slot_id:state.slot.id,block_name:state.name}),payload:[{name:"index",value:state.index}]}).then(function(data){return void 0!==data.extra?data.extra:data})},addable:function(state){var slot_cache=validation_add[state.slot.id],block_cache=void 0,response={slot:state.slot,block:state.block,name:state.name,index:state.index};return state.slot.editable?(void 0===slot_cache&&(slot_cache=validation_add[state.slot.id]={}),block_cache=slot_cache[state.name],void 0!==block_cache&&"resolved"==block_cache.state()?block_cache.then(function(data){return $.extend(response,{success:data.success,failed:data.failed,fatal:!1})}):slot_cache[state.name]=smi.ajax.query(urls.actions.addable.expand({path:path,slot_id:state.slot.id,block_name:state.name})).then(function(data){return $.extend(response,{success:data.success,failed:!data.success,fatal:!1})},function(){return $.Deferred().reject($.extend(response,{failed:!0,success:!1,fatal:!0}))})):$.Deferred().resolve($.extend(response,{failed:!0,success:!1,fatal:!1}))},edit:function(state){return state.current.$block.SMIFormPopup({url:urls.actions.edit.expand({path:path,slot_id:state.slot.id,block_id:state.current.id})}).done(function(data){void 0!==data.extra&&(state.current.$block.empty(),state.current.$block.append(data.extra.block_data),events.change.invoke({modified:!0,current:state.current,slot:state.slot}))})},movable:function(state){var block_cache=validation_move[state.current.id],slot_cache=void 0,response={slot:state.slot,current:state.current,index:state.index};return state.slot.editable?(void 0===block_cache&&(block_cache=validation_move[state.current.id]={}),slot_cache=block_cache[state.slot.id],void 0!==slot_cache&&"resolved"==slot_cache.state()?slot_cache.then(function(data){return $.extend(response,{success:data.success,failed:data.failed,fatal:!1})}):block_cache[state.slot.id]=smi.ajax.query(urls.actions.movable.expand({path:path,slot_id:state.slot.id,block_id:state.current.id})).then(function(data){return $.extend(response,{success:data.success,failed:!data.success,fatal:!1})},function(){return $.Deferred().reject($.extend(response,{failed:!0,success:!1,fatal:!0}))})):$.Deferred().resolve($.extend(response,{failed:!0,success:!1,fatal:!0}))},move:function(state){return smi.ajax.query(urls.actions.move.expand({path:path,slot_id:state.slot.id,block_id:state.current.id}),[{name:"index",value:state.index}]).then(function(data){return $.Deferred().resolve({success:data.success,failed:!data.success,slot:state.slot,current:state.current,index:state.index,fatal:!1})},function(){return $.Deferred().reject({failed:!0,success:!1,fatal:!0})})},remove:function(state){return smi.ajax.query(urls.actions.remove.expand({path:path,slot_id:state.slot.id,block_id:state.current.id})).done(function(data){data.success&&(state.slot.remove(state.current),state.current.destroy(),events.change.invoke({removed:!0,current:state.current,slot:state.slot}))})}};return api};$.extend(infrae.smi.layout,{utils:{Mouse:Mouse,Transport:Transport}})})(jQuery,infrae,jsontemplate);