(function($,infrae){var readZIndex=function($element){for(var position,value;$element.length&&null!==$element[0].ownerDocument;){if(position=$element.css("position"),("absolute"===position||"relative"===position||"fixed"===position)&&(value=parseInt($element.css("zIndex"),10),!isNaN(value)&&0!==value))return value;$element=$element.parent()}return 0},Element=function($element){var $current=$element,placeholding=null,api={zIndex:0,placeholder:{active:function(){return!1},clear:function(){},revert:function(){}},placehold:function($placeholder,height,width,initial){return this.placeholder.active()||(this.placeholder={$container:$current.parent(),$item:$current.prev(),direction:"after",$placeholder:$placeholder,width:width||this.width,height:height||this.height,active:function(){return null!==this.$placeholder},resize:function(fill_in){null!==this.$placeholder&&(fill_in===!1?(this.$placeholder.height(this.height),this.$placeholder.width("100%")):(this.$placeholder.width(this.width),this.$placeholder.height(this.height)))},revert:function(){null!==this.$placeholder&&(this.$placeholder.remove(),this.$placeholder=null,$current=$element,api.deplace(this))},clear:function(){null!==this.$placeholder&&($current.before($element),$current.remove(),this.$placeholder.remove(),this.$placeholder=null,$current=$element)}},$current=$placeholder,void 0===initial&&($element.before($placeholder),$element.detach(),this.placeholder.resize(void 0)),$placeholder.show()),this.placeholder},deplace:function(position,fill_in){position.$item.length?position.$item[position.direction]($current):position.$container.prepend($current),this.placeholder.active()&&this.placeholder.resize(fill_in)},destroy:function(){null!==placeholding&&($current.remove(),placeholding=null),$element.remove()},over:function(event){var x=event.pageX,y=event.pageY;return this.top>y||this.left>x||y>this.bottom||x>this.right?null:this},update:function(){var offset=$current.offset();this.top=offset.top,this.left=offset.left,this.height=$current.outerHeight(),this.width=$current.outerWidth(),this.bottom=this.top+this.height,this.right=this.left+this.width,this.zIndex=api.zIndex=readZIndex($current)}};return api},Block=function($block){var element,api={};return void 0===$block&&($block=$('<div class="contentlayout-edit-block" />')),element=Element($block),$.extend(api,element,{id:$block.data("block-id"),editable:$block.data("block-editable")===!0,$block:$block,set:function(data){this.id=data.block_id,this.editable=data.block_editable,this.$block.attr("data-block-id",data.block_id),this.$block.html(data.block_data),data.block_editable?this.$block.attr("data-block-editable","true"):this.$block.removeAttr("data-block-editable")}}),api},Slot=function($slot,selector){var element,api={},blocks=[],zIndex=0,editable=!0;return void 0!==$slot?void 0!==selector&&$(selector,$slot).each(function(){blocks.push(Block($(this)))}):($slot=$('<div class="contentlayout-edit-slot"></div>'),editable=!1,zIndex=99),!blocks.length&&editable&&$slot.addClass("contentlayout-empty-slot"),element=Element($slot),$.extend(api,element,{id:$slot.data("slot-id"),$slot:$slot,zIndex:zIndex,editable:editable,horizontal:!1,update:function(){for(var i=0;blocks.length>i;i++)blocks[i].update();element.update(),api.horizontal=!1,$.each(blocks,function(){return this.placeholder.active()?void 0:(api.horizontal=/left|right/.test(this.$block.css("float"))||/inline|table-cell/.test(this.$block.css("display")),!1)})},over:function(event){var current_slot=element.over(event),current_item=null;if(null!==current_slot){for(var i=0;blocks.length>i;i++)if(current_item=blocks[i].over(event),null!==current_item)return current_item;return this}return null},set:function(data){this.id=data.slot_id,this.$slot.attr("data-slot-id",data.slot_id)},get:function(index){return blocks[index]},index:function(item){return $.inArray(item,blocks)},size:function(){return blocks.length},add:function(item,index){blocks.length||$slot.removeClass("contentlayout-empty-slot"),void 0!==index?blocks.splice(index,0,item):blocks.push(item)},remove:function(item){var index=api.index(item),removed=null;return index>-1&&(removed=blocks.splice(index,1)[0]),!blocks.length&&this.editable&&$slot.addClass("contentlayout-empty-slot"),removed}}),api.update(),api};$.extend(infrae.smi.layout,{components:{Element:Element,Block:Block,Slot:Slot}})})(jQuery,infrae,jsontemplate);