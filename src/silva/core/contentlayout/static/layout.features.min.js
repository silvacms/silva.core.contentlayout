(function(e,t,n){var r=function(t){var n={$cover:null,add:function(){this.$cover=e('<div id="contentlayout-cover-layer" />'),this.$cover.appendTo(t.$body),this.update()},update:function(){this.$cover!==null&&(this.$cover.offset(t.$body.offset()),this.$cover.height(t.$body.outerHeight()),this.$cover.width(t.$body.outerWidth()))},destroy:function(){this.$cover.remove(),this.$cover=null}},r=function(e){e.current?n.$cover.zIndex(e.current.zIndex+5):n.$cover.zIndex(e.slot.zIndex+5)};return n.add(),t.$body.delegate("a","click",function(e){e.preventDefault()}),t.$body.disableSelection(),t.slots.events.onenter(function(){r(this)}),t.slots.events.onchange(function(){r(this)}),t.events.onresize(function(){n.update()}),n},i=function(n,r,i){var s=null,o=r.find("#contentlayout-actions"),u=o.find("#contentlayout-edit-block"),a={update:function(){s!==null&&(r.offset(s.current),r.width(s.current.width),r.height(s.current.height))},enable:function(e){var t=e.current.$block;t!==undefined&&(u.toggle(e.slot.editable&&e.current.editable),s===null&&r.appendTo(n.$body),r.zIndex(e.current.zIndex+10),s=e,a.update())},disable:function(){s!==null&&(r.detach(),s=null)}};o.bind("mousemove",function(e){e.stopPropagation()}),n.slots.events.onenter(function(){a.enable(this)}),n.slots.events.onchange(function(){a.enable(this)}),n.slots.events.onleave(function(){a.disable()}),n.transport.events.onchange(function(){n.slots.update(),this.modified?a.enable(this):this.removed&&a.disable()});var f=function(r){s!==null&&a.disable(),n.slots.drag(r),n.mode(t.smi.layout.AddMode,e(this)),r.stopPropagation(),r.preventDefault()},l=function(e){s!==null&&s.current.$block!==undefined&&n.transport.edit(s),e.stopPropagation(),e.preventDefault()},c=function(e){s!==null&&s.current.$block!==undefined&&(n.slots.drag(e),n.mode(t.smi.layout.MoveMode,s),a.disable()),e.stopPropagation(),e.preventDefault()},h=function(e){s!==null&&s.current.$block!==undefined&&(n.mode(t.smi.layout.RemoveMode,s),a.disable()),e.stopPropagation(),e.preventDefault()};return i.delegate("div.contentlayout-component","mousedown",f),r.delegate("#contentlayout-edit-block","click",l),n.shortcuts.bind("editor",null,["ctrl+e"],l),r.delegate("#contentlayout-move-block","mousedown",c),n.shortcuts.bind("editor",null,["ctrl+m"],c),r.delegate("#contentlayout-remove-block","click",h),n.shortcuts.bind("editor",null,["ctrl+d"],h),n.events.onresize(function(){a.update()}),a},s=function(n,r){var i=null,s=[],o=function(t){i===null&&(i=e('<div id="contentlayout-lost-slots"><h2>Place those components</h2></div>'),n.$body.append(i),u()),i.append(t.$slot),t.update(),s.push(t),n.slots.add(t)},u=function(){if(i!==null){var e=n.$body.width(),t=i.width(),r=Math.max(t,Math.min(500,e-200));r!=t&&i.width(r),i.offset({top:100,left:(e-r)/2})}},a=function(){if(i!==null){var e=s.length;while(e--)s[e].size()||(s[e].destroy(),s.splice(e,1));s.length||(i.remove(),i=null)}};for(var f in r){var l=t.smi.layout.components.Slot(),c,h=r[f],p=0;l.set({slot_id:f});for(;p<h.length;p++)c=t.smi.layout.components.Block(),c.set(h[p]),l.$slot.append(c.$block),l.add(c);p&&o(l)}n.events.onmodestart(function(){i!==null&&(i.fadeOut(),i.promise().done(function(){n.slots.update()}))}),n.events.onmodestop(function(){a(),i!==null&&(i.fadeIn(),i.promise().done(function(){n.slots.update()}))}),n.events.onresize(function(){u()})};e.extend(t.smi.layout,{EditorFeature:i,CoverFeature:r,LostFeature:s})})(jQuery,infrae,jsontemplate);