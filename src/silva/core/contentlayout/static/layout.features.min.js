(function($,infrae){var CoverFeature=function(view){var api={$cover:null,add:function(){this.$cover=$('<div id="contentlayout-cover-layer" />'),this.$cover.appendTo(view.$body),this.update()},update:function(){null!==this.$cover&&(this.$cover.offset(view.$body.offset()),this.$cover.height(view.$body.outerHeight()),this.$cover.width(view.$body.outerWidth()))},destroy:function(){this.$cover.remove(),this.$cover=null}},cover=function(selected){void 0!==selected?selected.current?api.$cover.zIndex(selected.current.zIndex+5):api.$cover.zIndex(selected.slot.zIndex+5):api.$cover.zIndex(5)};return api.add(),view.$body.delegate("a","click",function(event){event.preventDefault()}),view.$body.disableSelection(),view.slots.events.onenter(function(){cover(this)}),view.slots.events.onchange(function(){cover(this)}),view.slots.events.onleave(function(){cover()}),view.events.onresize(function(){api.update()}),api},EditorFeature=function(view,$layer,$components){var selected=null,$actions=$layer.find(".contentlayout-actions"),$edit=$actions.find("#contentlayout-edit-block"),api={update:function(){null!==selected&&($layer.offset(selected.current),$layer.width(selected.current.width),$layer.height(selected.current.height))},enable:function(other){var $block=other.current.$block;void 0!==$block&&($edit.toggle(other.slot.editable&&other.current.editable),null===selected&&$layer.appendTo(view.$body),$layer.zIndex(other.current.zIndex+10),selected=other,api.update())},disable:function(){null!==selected&&($layer.detach(),selected=null)}};$actions.bind("mousemove",function(event){event.stopPropagation()}),view.slots.events.onenter(function(){api.enable(this)}),view.slots.events.onchange(function(){api.enable(this)}),view.slots.events.onleave(function(){api.disable()}),view.transport.events.onchange(function(){view.slots.update(),this.modified?api.enable(this):this.removed&&api.disable()});var add=function(event){null!==selected&&api.disable(),view.slots.drag(event),view.mode(infrae.smi.layout.AddMode,$(this)),event.stopPropagation(),event.preventDefault()},edit=function(event){null!==selected&&void 0!==selected.current.$block&&view.transport.edit(selected),event.stopPropagation(),event.preventDefault()},move=function(event){null!==selected&&void 0!==selected.current.$block&&(view.slots.drag(event),view.mode(infrae.smi.layout.MoveMode,selected),api.disable()),event.stopPropagation(),event.preventDefault()},remove=function(event){null!==selected&&void 0!==selected.current.$block&&(view.mode(infrae.smi.layout.RemoveMode,selected),api.disable()),event.stopPropagation(),event.preventDefault()};return $components.delegate("div.contentlayout-component","mousedown",add),$layer.delegate("#contentlayout-edit-block","click",edit),view.shortcuts.bind("editor",null,["ctrl+e"],edit),$layer.delegate("#contentlayout-move-block","mousedown",move),view.shortcuts.bind("editor",null,["ctrl+m"],move),$layer.delegate("#contentlayout-remove-block","click",remove),view.shortcuts.bind("editor",null,["ctrl+d"],remove),view.events.onresize(function(){api.update()}),api},LostFeature=function(view,template,data){var $lost=null,$slots=null,slots=[],add=function(slot){null===$lost&&($lost=$(template),$lost.find("#contentlayout-remove-all-blocks").bind("click",function(event){var selected=[];infrae.utils.each(slots,function(slot){for(var index=slot.size();index--;)selected.push({slot:slot,current:slot.get(index)})}),view.mode(infrae.smi.layout.RemoveAllMode,selected),event.preventDefault(),event.stopPropagation()}),$slots=$lost.children("#contentlayout-lost-blocks"),view.$body.append($lost),place()),$slots.append(slot.$slot),slot.update(),slots.push(slot),view.slots.add(slot)},place=function(){if(null!==$lost){var available_width=view.$body.width(),current_width=$lost.width(),new_width=Math.min(500,available_width-300);new_width!=current_width&&$lost.width(new_width),$lost.offset({top:100,left:(available_width-new_width)/2})}},clean=function(){if(null!==$lost){for(var index=slots.length;index--;)slots[index].size()||(slots[index].destroy(),slots.splice(index,1));slots.length||($lost.remove(),$lost=null,$slots=null)}};for(var name in data){var block,slot=infrae.smi.layout.components.Slot(),lost=data[name],index=0;for(slot.set({slot_id:name});lost.length>index;index++)block=infrae.smi.layout.components.Block(),block.set(lost[index]),slot.$slot.append(block.$block),slot.add(block);index&&add(slot)}view.events.onmodestart(function(){null!==$lost&&($lost.fadeOut(),$lost.promise().done(function(){view.slots.update()}))}),view.events.onmodestop(function(){clean(),null!==$lost&&($lost.fadeIn(),$lost.promise().done(function(){view.slots.update()}))}),view.events.onresize(function(){place()})};$.extend(infrae.smi.layout,{EditorFeature:EditorFeature,CoverFeature:CoverFeature,LostFeature:LostFeature})})(jQuery,infrae,jsontemplate);