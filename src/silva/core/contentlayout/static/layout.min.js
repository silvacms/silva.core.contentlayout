(function(e,t,n){t.interfaces.register("content-layout");var r=function(e){var t={};for(var i in e)typeof e[i]=="string"?t[i]=new n.Template(e[i],{}):t[i]=r(e[i]);return t},i=function(n,r,i,s){var o=null,u=null,a=[],f=null,l=t.smi.layout.utils.Mouse(),c={started:!1,dragued:!1,captured:!1},h={enter:t.deferred.Callbacks(),change:t.deferred.Callbacks(),leave:t.deferred.Callbacks(),move:t.deferred.Callbacks(),drop:t.deferred.Callbacks(),cancel:t.deferred.Callbacks()},p=function(){a.sort(function(e,t){return t.zIndex-e.zIndex})},d={events:{onenter:function(e){h.enter.add(e)},onchange:function(e){h.change.add(e)},onleave:function(e){h.leave.add(e)},onmove:function(e){h.move.add(e)},ondrop:function(e){h.drop.add(e)},oncancel:function(e){h.cancel.add(e)},snapshot:function(){for(var e in h)h[e].push()},restore:function(e){for(var t in h)h[t].pop();e!==undefined&&!m(e)&&o!==null&&h.enter.invoke(v(),[e])}},add:function(e){a.push(e),p()},size:function(){return a.length},drag:function(e){c.started&&h.cancel.invoke(v(),[e]),l.update(e),c.started=!0,c.dragued=!0,c.captured=!1},update:function(){for(var e=0;e<a.length;e++)a[e].update()},remove:function(t){var n=e.inArray(t,a),r=null;return n>-1&&(r=a.splice(n,1)[0]),r}},v=function(){return{mouse:l,current:o,slot:u}},m=function(e){var t=null,n=o;for(var r=0;r<a.length;r++){t=a[r].over(e);if(t!==null)return u=a[r],t!==o?(o=t,n===null?h.enter.invoke(v(),[e]):h.change.invoke(v(),[e]),!0):!1}return o!==null?(h.leave.invoke(v(),[e]),o=null,u=null,!0):!1};return r.each(function(){a.push(t.smi.layout.components.Slot(e(this),i))}),p(),s.bind("mousedown.contentlayout",function(e){if(c.started&&!c.dragued){h.drop.invoke(v(),[e]),c.started=!1;return}d.drag(e)}),s.bind("mouseup.contentlayout",function(e){c.started&&(c.captured?(h.drop.invoke(v(),[e]),e.stopPropagation(),e.preventDefault(),c.started=!1):c.dragued=!1)}),s.bind("mousemove.contentlayout",function(e){f!==null&&clearTimeout(f),f=setTimeout(function(){if(!l.update(e))return;c.started&&c.dragued&&!c.captured&&(c.captured=!0),n.get(0)===e.delegateTarget&&!m(e)&&h.move.invoke(v(),[e]),l.finish(e),f=null},0)}),d};e(document).bind("load-smiplugins",function(n,s){var o=r(s.options.contentlayout),u={minWidth:250,minHeight:250,position:[30,"center"]};t.views.view({iface:"content-layout",name:"toolbar",factory:function(n,r,i,s){return{html:'<div class="actions layout-actions"><ol><li class="last-action"><a class="ui-state-default component-action"><div class="action-icon"><ins class="ui-icon ui-icon-newwin"></ins></div><span class="have-icon">Components</span></a></li></ol></div>',render:function(){var i=r.menu.actions,o=n.find(".component-action"),u=function(e){s.components.toggle(),e.preventDefault(),e.stopPropagation()};o.bind("click",u),s.shortcuts.bind("editor",null,["ctrl+t"],u),s.components.opened()&&o.addClass("active"),s.events.oncomponents(function(){o.toggleClass("active")});if(i&&i.entries.length){var a=e('<div class="actions content-actions"><ol></ol></div>');a.find("ol").render({data:i}),n.append(a)}t.ui.selection.disable(n)},cleanup:function(){n.empty(),t.ui.selection.enable(n)}}}}),t.views.view({iface:"content-layout",name:"content",factory:function(n,r,s){var a=s.opened.path+(r.identifier?"/"+r.identifier:""),f=!1,l=e(r.templates.components),c=l.children(".contentlayout-components"),h=e(r.templates.layer),p=null,d=!1,v={resize:t.deferred.Callbacks(),components:t.deferred.Callbacks(),modestart:t.deferred.Callbacks(),modestop:t.deferred.Callbacks()};return{html_url:o.url.expand({path:a}),iframe:!0,template_nocache:!0,transport:t.smi.layout.utils.Transport(s,o,a),shortcuts:s.shortcuts,events:{oncomponents:function(e){v.components.add(e)},onresize:function(e){v.resize.add(e)},onmodestart:function(e){v.modestart.add(e)},onmodestop:function(e){v.modestop.add(e)}},components:{open:function(){f===!1&&(t.ui.ShowDialog(l,u),f=!0,v.components.invoke({active:!0}))},opened:function(){return f},close:function(){f===!0&&l.dialog("close")},toggle:function(){f===!1?this.open():this.close()}},mode:function(e){if(!d){var t=this,n=[].splice.call(arguments,1,2),r=function(){p=e.apply(t,n),p.promise().always(function(){v.modestop.invoke(p),p=null,d=!1}),v.modestart.invoke(p)};p!==null?(d=!0,p.cancel(),p.promise().always(r)):r()}},render:function(n){this.shortcuts.create("editor",n,!0),this.ready.done(function(n){n.$body=n.$document.find("body"),n.slots=i(n.$document,n.$body.find(".contentlayout-edit-slot"),"> .contentlayout-edit-block",e(document).add(n.$document)),t.smi.layout.CoverFeature(n),t.smi.layout.EditorFeature(n,h,l),n.events.onresize(function(){n.slots.update()}),t.smi.layout.LostFeature(n,r.templates.missing,r.missing);var s=null;n.$window.bind("resize",function(){s!==null&&clearTimeout(s),s=setTimeout(function(){v.resize.invoke(n),s=null},50)})});var s=e('<div id="smi-cover">');l.dialog({closeOnEscape:!1,autoOpen:!1,width:250,height:400,open:function(){c.accordion({fillSpace:!0})},dragStart:function(){e("body").append(s)},resizeStart:function(){e("body").append(s)},dragStop:function(){s.detach(),u.position=l.dialog("option","position")},resize:function(){c.accordion("resize")},resizeStop:function(){s.detach()}}),l.bind("infrae-ui-dialog-resized",function(){c.accordion("resize")}),l.bind("dialogclose",function(){f=!1,v.components.invoke({active:!1})}),t.ui.selection.disable(l),this.components.open()},cleanup:function(){this.components.close(),this.shortcuts.remove("editor"),e(document).unbind(".contentlayout"),l.remove(),n.empty()}}}})}),t.smi.layout={}})(jQuery,infrae,jsontemplate);