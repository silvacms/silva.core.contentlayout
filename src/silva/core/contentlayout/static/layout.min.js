(function($,infrae,jsontemplate){infrae.interfaces.register("content-layout");var prepare_urls=function(templates){var prepared={};for(var key in templates)prepared[key]="string"==typeof templates[key]?new jsontemplate.Template(templates[key],{}):prepare_urls(templates[key]);return prepared},Slots=function($document,$slots,selector,$target){var current=null,slot=null,slots=[],timer=null,mouse=infrae.smi.layout.utils.Mouse(),dnd={started:!1,dragued:!1,captured:!1},events={enter:infrae.deferred.Callbacks(),change:infrae.deferred.Callbacks(),leave:infrae.deferred.Callbacks(),move:infrae.deferred.Callbacks(),drop:infrae.deferred.Callbacks(),cancel:infrae.deferred.Callbacks()},sort=function(){slots.sort(function(a,b){return b.zIndex-a.zIndex})},api={events:{onenter:function(callback){events.enter.add(callback)},onchange:function(callback){events.change.add(callback)},onleave:function(callback){events.leave.add(callback)},onmove:function(callback){events.move.add(callback)},ondrop:function(callback){events.drop.add(callback)},oncancel:function(callback){events.cancel.add(callback)},snapshot:function(){for(var name in events)events[name].push()},restore:function(event){for(var name in events)events[name].pop();void 0!==event&&(lookup(event)||null===current||events.enter.invoke(SlotEvent(),[event]))}},add:function(slot){slots.push(slot),sort()},size:function(){return slots.length},drag:function(event){dnd.started&&events.cancel.invoke(SlotEvent(),[event]),mouse.update(event),dnd.started=!0,dnd.dragued=!0,dnd.captured=!1},update:function(){for(var i=0;slots.length>i;i++)slots[i].update()},remove:function(slot){var index=$.inArray(slot,slots),removed=null;return index>-1&&(removed=slots.splice(index,1)[0]),removed}},SlotEvent=function(){return{mouse:mouse,current:current,slot:slot}},lookup=function(event){for(var new_current=null,previous_current=current,i=0;slots.length>i;i++)if(new_current=slots[i].over(event),null!==new_current)return slot=slots[i],new_current!==current?(current=new_current,null===previous_current?events.enter.invoke(SlotEvent(),[event]):events.change.invoke(SlotEvent(),[event]),!0):!1;return null!==current?(events.leave.invoke(SlotEvent(),[event]),current=null,slot=null,!0):!1};return $slots.each(function(){slots.push(infrae.smi.layout.components.Slot($(this),selector))}),sort(),$target.bind("mousedown.contentlayout",function(event){return dnd.started&&!dnd.dragued?(events.drop.invoke(SlotEvent(),[event]),dnd.started=!1,void 0):(api.drag(event),void 0)}),$target.bind("mouseup.contentlayout",function(event){dnd.started&&(dnd.captured?(events.drop.invoke(SlotEvent(),[event]),event.stopPropagation(),event.preventDefault(),dnd.started=!1):dnd.dragued=!1)}),$target.bind("mousemove.contentlayout",function(event){null!==timer&&clearTimeout(timer),timer=setTimeout(function(){mouse.update(event)&&(dnd.started&&dnd.dragued&&!dnd.captured&&(dnd.captured=!0),$document.get(0)!==event.delegateTarget||lookup(event)||events.move.invoke(SlotEvent(),[event]),mouse.finish(event),timer=null)},0)}),api};$(document).bind("load-smiplugins",function(event,smi){var urls=prepare_urls(smi.options.contentlayout),settings={minWidth:250,minHeight:250,position:[30,"center"]};infrae.views.view({iface:"content-layout",name:"toolbar",factory:function($content,data,smi,view){return{html:'<div class="actions layout-actions"><ol><li class="last-action"><a class="ui-state-default component-action"><div class="action-icon"><ins class="ui-icon ui-icon-newwin"></ins></div><span class="have-icon">Components</span></a></li></ol></div>',render:function(){var actions=data.menu.actions,$component=$content.find(".component-action"),toggle=function(event){view.components.toggle(),event.preventDefault(),event.stopPropagation()};if($component.bind("click",toggle),view.shortcuts.bind("editor",null,["ctrl+t"],toggle),view.components.opened()&&$component.addClass("active"),view.events.oncomponents(function(){$component.toggleClass("active")}),actions&&actions.entries.length){var $menu=$('<div class="actions content-actions"><ol></ol></div>');$menu.find("ol").render({data:actions}),$content.append($menu)}infrae.ui.selection.disable($content)},cleanup:function(){$content.empty(),infrae.ui.selection.enable($content)}}}}),infrae.views.view({iface:"content-layout",name:"content",factory:function($content,data,smi){var path=smi.opened.path+(data.identifier?"/"+data.identifier:""),opened=!1,$components=$(data.templates.components),$listing=$components.children(".contentlayout-components"),$layer=$(data.templates.layer),active=null,stopping=!1,events={resize:infrae.deferred.Callbacks(),components:infrae.deferred.Callbacks(),modestart:infrae.deferred.Callbacks(),modestop:infrae.deferred.Callbacks()};return{html_url:urls.url.expand({path:path}),iframe:!0,template_nocache:!0,transport:infrae.smi.layout.utils.Transport(smi,urls,path),shortcuts:smi.shortcuts,events:{oncomponents:function(callback){events.components.add(callback)},onresize:function(callback){events.resize.add(callback)},onmodestart:function(callback){events.modestart.add(callback)},onmodestop:function(callback){events.modestop.add(callback)}},components:{open:function(){opened===!1&&(infrae.ui.ShowDialog($components,settings),opened=!0,events.components.invoke({active:!0}))},opened:function(){return opened},close:function(){opened===!0&&$components.dialog("close")},toggle:function(){opened===!1?this.open():this.close()}},mode:function(mode){if(!stopping){var context=this,options=[].splice.call(arguments,1,2),start=function(){active=mode.apply(context,options),active.promise().always(function(){events.modestop.invoke(active),active=null,stopping=!1}),events.modestart.invoke(active)};null!==active?(stopping=!0,active.cancel(),active.promise().always(start)):start()}},render:function($content){this.shortcuts.create("editor",$content,!0),this.ready.done(function(view){view.$body=view.$document.find("body"),view.slots=Slots(view.$document,view.$body.find(".contentlayout-edit-slot"),"> .contentlayout-edit-block",$(document).add(view.$document)),infrae.smi.layout.CoverFeature(view),infrae.smi.layout.EditorFeature(view,$layer,$components),view.events.onresize(function(){view.slots.update()}),infrae.smi.layout.LostFeature(view,data.templates.missing,data.missing);var timer=null;view.$window.bind("resize",function(){null!==timer&&clearTimeout(timer),timer=setTimeout(function(){events.resize.invoke(view),timer=null},50)})});var $cover=$('<div id="smi-cover">');$components.dialog({closeOnEscape:!1,autoOpen:!1,width:250,height:400,open:function(){$listing.accordion({fillSpace:!0})},dragStart:function(){$("body").append($cover)},resizeStart:function(){$("body").append($cover)},dragStop:function(){$cover.detach(),settings.position=$components.dialog("option","position")},resize:function(){$listing.accordion("resize")},resizeStop:function(){$cover.detach()}}),$components.bind("infrae-ui-dialog-resized",function(){$listing.accordion("resize")}),$components.bind("dialogclose",function(){opened=!1,events.components.invoke({active:!1})}),infrae.ui.selection.disable($components),this.components.open()},cleanup:function(){this.components.close(),this.shortcuts.remove("editor"),$(document).unbind(".contentlayout"),$components.remove(),$content.empty()}}}})}),infrae.smi.layout={}})(jQuery,infrae,jsontemplate);